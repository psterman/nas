<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ–‡ä»¶æµè§ˆå™¨ - Web NAS</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f5f5f5;
            color: #333;
            line-height: 1.6;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        header {
            background-color: #4a6cf7;
            color: white;
            padding: 15px 0;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }

        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 20px;
        }

        .logo {
            font-size: 24px;
            font-weight: bold;
            cursor: pointer;
        }

        .user-info {
            display: flex;
            align-items: center;
        }

        .user-name {
            margin-right: 15px;
        }

        .logout-btn {
            background-color: transparent;
            border: 1px solid white;
            color: white;
            padding: 5px 10px;
            border-radius: 4px;
            cursor: pointer;
        }

        .logout-btn:hover {
            background-color: rgba(255, 255, 255, 0.1);
        }

        .main-content {
            margin-top: 30px;
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
            padding: 30px;
        }

        h1 {
            margin-top: 0;
            color: #333;
        }

        .breadcrumb {
            display: flex;
            align-items: center;
            margin-bottom: 20px;
            font-size: 14px;
        }

        .breadcrumb a {
            color: #4a6cf7;
            text-decoration: none;
        }

        .breadcrumb a:hover {
            text-decoration: underline;
        }

        .breadcrumb .separator {
            margin: 0 8px;
            color: #6c757d;
        }

        .file-browser-container {
            display: grid;
            grid-template-columns: 250px 1fr;
            gap: 20px;
            margin-top: 20px;
        }

        .sidebar {
            background-color: #f8f9fa;
            border-radius: 8px;
            padding: 15px;
        }

        .sidebar-section {
            margin-bottom: 20px;
        }

        .sidebar-section h3 {
            margin-top: 0;
            margin-bottom: 10px;
            font-size: 16px;
            color: #6c757d;
        }

        .sidebar-item {
            display: flex;
            align-items: center;
            padding: 8px 10px;
            border-radius: 4px;
            cursor: pointer;
        }

        .sidebar-item:hover {
            background-color: #e9ecef;
        }

        .sidebar-item.active {
            background-color: #e2e6ea;
        }

        .sidebar-icon {
            margin-right: 10px;
            font-size: 1.2rem;
        }

        .main-area {
            display: flex;
            flex-direction: column;
        }

        .toolbar {
            display: flex;
            justify-content: space-between;
            margin-bottom: 20px;
        }

        .search-box {
            padding: 8px 12px;
            border: 1px solid #ced4da;
            border-radius: 4px;
            width: 300px;
        }

        .action-buttons {
            display: flex;
            gap: 10px;
        }

        .btn {
            background-color: #4a6cf7;
            color: white;
            border: none;
            border-radius: 4px;
            padding: 8px 15px;
            cursor: pointer;
            display: flex;
            align-items: center;
        }

        .btn:hover {
            background-color: #3a5bd9;
        }

        .btn-icon {
            margin-right: 5px;
        }

        .view-options {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }

        .view-option {
            background: none;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            padding: 5px 10px;
            cursor: pointer;
        }

        .view-option.active {
            background-color: #e2e6ea;
        }

        .file-list {
            border: 1px solid #dee2e6;
            border-radius: 8px;
            overflow: hidden;
        }

        .file-list-header {
            display: grid;
            grid-template-columns: 40px 2fr 1fr 1fr 100px;
            background-color: #f8f9fa;
            padding: 10px 15px;
            font-weight: 500;
            border-bottom: 1px solid #dee2e6;
        }

        .file-item {
            display: grid;
            grid-template-columns: 40px 2fr 1fr 1fr 100px;
            padding: 10px 15px;
            border-bottom: 1px solid #f0f0f0;
            align-items: center;
        }

        .file-item:hover {
            background-color: #f8f9fa;
        }

        .file-icon {
            font-size: 1.2rem;
            width: 30px;
            text-align: center;
        }

        .file-icon img {
            width: 24px;
            height: 24px;
            vertical-align: middle;
        }

        .file-name {
            font-weight: 500;
        }

        .file-size,
        .file-date {
            color: #6c757d;
            font-size: 0.9rem;
        }

        .file-actions {
            display: flex;
            gap: 5px;
        }

        .action-btn {
            background: none;
            border: none;
            color: #6c757d;
            cursor: pointer;
            font-size: 1rem;
        }

        .action-btn:hover {
            color: #4a6cf7;
        }

        .grid-view {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 15px;
            padding: 15px;
        }

        .grid-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 15px;
            border-radius: 8px;
            cursor: pointer;
            text-align: center;
        }

        .grid-item:hover {
            background-color: #f8f9fa;
        }

        .grid-icon {
            font-size: 2.5rem;
            margin-bottom: 10px;
        }

        .grid-icon img {
            width: 48px;
            height: 48px;
        }

        .grid-name {
            font-weight: 500;
            margin-bottom: 5px;
            word-break: break-word;
        }

        .grid-info {
            color: #6c757d;
            font-size: 0.8rem;
        }

        .empty-state {
            text-align: center;
            padding: 50px 20px;
            color: #6c757d;
        }

        .empty-state-icon {
            font-size: 3rem;
            margin-bottom: 20px;
            color: #dee2e6;
        }

        .debug-info {
            margin-top: 30px;
            padding: 15px;
            background-color: #f8f9fa;
            border-radius: 4px;
            border: 1px solid #dee2e6;
            font-family: monospace;
            white-space: pre-wrap;
            max-height: 300px;
            overflow: auto;
        }

        .cloudinary-status {
            display: flex;
            align-items: center;
            margin-bottom: 15px;
            padding: 10px;
            border-radius: 4px;
            font-size: 14px;
        }

        .cloudinary-status.connected {
            background-color: #e6f7e6;
            color: #2e7d32;
            border: 1px solid #c8e6c9;
        }

        .cloudinary-status.disconnected {
            background-color: #ffebee;
            color: #c62828;
            border: 1px solid #ffcdd2;
        }

        .cloudinary-status-icon {
            margin-right: 10px;
            font-size: 18px;
        }

        .cloudinary-settings-btn {
            margin-left: auto;
            background-color: #4a6cf7;
            color: white;
            border: none;
            border-radius: 4px;
            padding: 5px 10px;
            cursor: pointer;
        }

        .cloudinary-settings-btn:hover {
            background-color: #3a5bd9;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }

        .modal-content {
            background-color: white;
            padding: 20px;
            border-radius: 8px;
            width: 400px;
            max-width: 90%;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .modal-title {
            font-size: 18px;
            font-weight: 500;
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 20px;
            cursor: pointer;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
        }

        .form-group input {
            width: 100%;
            padding: 8px;
            border: 1px solid #ced4da;
            border-radius: 4px;
        }

        .form-actions {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        }

        .btn-secondary {
            background-color: #6c757d;
            color: white;
            border: none;
            border-radius: 4px;
            padding: 8px 15px;
            cursor: pointer;
        }

        .btn-secondary:hover {
            background-color: #5a6268;
        }

        /* é¢„è§ˆæ¨¡æ€æ¡†æ ·å¼ */
        .preview-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.9);
            z-index: 1000;
            justify-content: center;
            align-items: center;
            flex-direction: column;
        }

        .preview-content {
            max-width: 90%;
            max-height: 80%;
            position: relative;
        }

        .preview-header {
            position: absolute;
            top: -40px;
            left: 0;
            right: 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
            color: white;
        }

        .preview-title {
            font-size: 18px;
            font-weight: 500;
        }

        .preview-close {
            background: none;
            border: none;
            color: white;
            font-size: 24px;
            cursor: pointer;
            padding: 5px 10px;
        }

        .preview-image {
            max-width: 100%;
            max-height: 80vh;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.5);
        }

        .preview-video {
            max-width: 100%;
            max-height: 80vh;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.5);
        }

        .preview-audio {
            width: 100%;
            max-width: 500px;
        }

        .preview-pdf {
            width: 100%;
            height: 80vh;
            border: none;
        }

        .preview-text {
            width: 100%;
            max-width: 800px;
            max-height: 80vh;
            background-color: white;
            padding: 20px;
            border-radius: 8px;
            overflow: auto;
            white-space: pre-wrap;
            font-family: monospace;
        }

        .preview-controls {
            margin-top: 15px;
            display: flex;
            gap: 10px;
        }

        .preview-btn {
            background-color: #4a6cf7;
            color: white;
            border: none;
            border-radius: 4px;
            padding: 8px 15px;
            cursor: pointer;
            display: flex;
            align-items: center;
        }

        .preview-btn:hover {
            background-color: #3a5bd9;
        }

        .video-player-container {
            position: relative;
            width: 100%;
            max-width: 800px;
        }

        .video-player {
            width: 100%;
            height: auto;
            max-height: 80vh;
            background-color: #000;
        }

        .video-controls {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            background-color: rgba(0, 0, 0, 0.5);
            padding: 10px;
            display: flex;
            align-items: center;
            opacity: 0;
            transition: opacity 0.3s;
        }

        .video-player-container:hover .video-controls {
            opacity: 1;
        }

        .video-progress {
            flex-grow: 1;
            height: 5px;
            background-color: #555;
            margin: 0 10px;
            position: relative;
            cursor: pointer;
        }

        .video-progress-bar {
            height: 100%;
            background-color: #4a6cf7;
            width: 0;
        }

        .video-time {
            color: white;
            font-size: 12px;
            min-width: 80px;
        }

        .video-control-btn {
            background: none;
            border: none;
            color: white;
            cursor: pointer;
            font-size: 16px;
            padding: 5px;
        }
    </style>
</head>

<body>
    <header>
        <div class="header-content">
            <div class="logo" onclick="window.location.href='index.html'">Web NAS</div>
            <div class="user-info">
                <span class="user-name" id="username">åŠ è½½ä¸­...</span>
                <button class="logout-btn" id="logout-btn">é€€å‡ºç™»å½•</button>
            </div>
        </div>
    </header>

    <div class="container">
        <div class="main-content">
            <div class="breadcrumb">
                <a href="index.html">é¦–é¡µ</a>
                <span class="separator">/</span>
                <span>æ–‡ä»¶æµè§ˆå™¨</span>
                <span id="folder-path"></span>
            </div>

            <h1>æ–‡ä»¶æµè§ˆå™¨</h1>

            <!-- Cloudinary è¿æ¥çŠ¶æ€ -->
            <div id="cloudinary-status" class="cloudinary-status">
                <span class="cloudinary-status-icon">â³</span>
                <span>æ­£åœ¨æ£€æŸ¥ Cloudinary è¿æ¥çŠ¶æ€...</span>
                <button class="cloudinary-settings-btn" id="cloudinary-settings-btn">è®¾ç½®</button>
            </div>

            <div class="file-browser-container">
                <div class="sidebar">
                    <div class="sidebar-section">
                        <h3>å¿«é€Ÿè®¿é—®</h3>
                        <div class="sidebar-item active">
                            <span class="sidebar-icon">ğŸ“‚</span>
                            <span>å…¨éƒ¨æ–‡ä»¶</span>
                        </div>
                        <div class="sidebar-item">
                            <span class="sidebar-icon">â­</span>
                            <span>æ”¶è—</span>
                        </div>
                        <div class="sidebar-item">
                            <span class="sidebar-icon">ğŸ•’</span>
                            <span>æœ€è¿‘</span>
                        </div>
                    </div>
                    <div class="sidebar-section">
                        <h3>åˆ†ç±»</h3>
                        <div class="sidebar-item">
                            <span class="sidebar-icon">ğŸ“„</span>
                            <span>æ–‡æ¡£</span>
                        </div>
                        <div class="sidebar-item">
                            <span class="sidebar-icon">ğŸ–¼ï¸</span>
                            <span>å›¾ç‰‡</span>
                        </div>
                        <div class="sidebar-item">
                            <span class="sidebar-icon">ğŸµ</span>
                            <span>éŸ³ä¹</span>
                        </div>
                        <div class="sidebar-item">
                            <span class="sidebar-icon">ğŸ¬</span>
                            <span>è§†é¢‘</span>
                        </div>
                    </div>
                </div>
                <div class="main-area">
                    <div class="toolbar">
                        <input type="text" class="search-box" placeholder="æœç´¢æ–‡ä»¶...">
                        <div class="action-buttons">
                            <button class="btn" id="upload-btn">
                                <span class="btn-icon">â¬†ï¸</span>
                                ä¸Šä¼ 
                            </button>
                            <button class="btn" id="new-folder-btn">
                                <span class="btn-icon">ğŸ“</span>
                                æ–°å»ºæ–‡ä»¶å¤¹
                            </button>
                        </div>
                    </div>
                    <div class="view-options">
                        <button class="view-option active" id="list-view-btn">åˆ—è¡¨è§†å›¾</button>
                        <button class="view-option" id="grid-view-btn">ç½‘æ ¼è§†å›¾</button>
                    </div>
                    <div id="file-container" class="file-list">
                        <div class="file-list-header">
                            <div></div>
                            <div>åç§°</div>
                            <div>å¤§å°</div>
                            <div>ä¿®æ”¹æ—¥æœŸ</div>
                            <div>æ“ä½œ</div>
                        </div>
                        <div id="file-items-container">
                            <!-- æ–‡ä»¶é¡¹å°†åœ¨è¿™é‡ŒåŠ¨æ€ç”Ÿæˆ -->
                        </div>
                    </div>
                </div>
            </div>

            <div class="debug-info" id="debug-info"></div>
        </div>
    </div>

    <!-- Cloudinary è®¾ç½®æ¨¡æ€æ¡† -->
    <div id="cloudinary-settings-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Cloudinary è®¾ç½®</h3>
                <button class="modal-close" id="modal-close">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label for="cloudinary-api-key">API Key</label>
                    <input type="text" id="cloudinary-api-key" placeholder="è¾“å…¥ Cloudinary API Key">
                </div>
                <div class="form-group">
                    <label for="cloudinary-api-secret">API Secret</label>
                    <input type="password" id="cloudinary-api-secret" placeholder="è¾“å…¥ Cloudinary API Secret">
                </div>
                <div class="form-actions">
                    <button class="btn-secondary" id="modal-cancel">å–æ¶ˆ</button>
                    <button class="btn" id="save-cloudinary-settings">ä¿å­˜</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // è°ƒè¯•æ—¥å¿—å‡½æ•°
        function debugLog(message) {
            const debugInfo = document.getElementById('debug-info');
            const timestamp = new Date().toLocaleTimeString();
            debugInfo.innerHTML += `[${timestamp}] ${message}\n`;
            debugInfo.scrollTop = debugInfo.scrollHeight;
            console.log(message);
        }

        // æ£€æµ‹å½“å‰ç¯å¢ƒå¹¶è¿”å›é€‚å½“çš„APIåŸºç¡€URL
        function getApiBaseUrl() {
            const currentUrl = window.location.href;
            debugLog(`å½“å‰é¡µé¢URL: ${currentUrl}`);

            // å¦‚æœåœ¨GitHub Pagesä¸Š
            if (currentUrl.includes('github.io')) {
                debugLog('æ£€æµ‹åˆ°GitHub Pagesç¯å¢ƒ');
                // æ›¿æ¢ä¸ºæ‚¨å®é™…éƒ¨ç½²çš„åç«¯æœåŠ¡å™¨åœ°å€
                return 'https://your-backend-server.com';
            }

            // å¦‚æœåœ¨æœ¬åœ°å¼€å‘ç¯å¢ƒï¼ˆlocalhost:3000ï¼‰
            if (currentUrl.includes('localhost:3000')) {
                debugLog('æ£€æµ‹åˆ°Node.jsæœåŠ¡å™¨ç¯å¢ƒ');
                return '';
            }

            // å¦‚æœåœ¨VS Code Live Serverï¼ˆlocalhost:5500æˆ–127.0.0.1:5500ï¼‰
            if (currentUrl.includes('127.0.0.1:5500') || currentUrl.includes('localhost:5500')) {
                debugLog('æ£€æµ‹åˆ°Live Serverç¯å¢ƒ');
                return 'http://localhost:3000';
            }

            // é»˜è®¤ä½¿ç”¨æœ¬åœ°æœåŠ¡å™¨
            debugLog('ä½¿ç”¨é»˜è®¤æœ¬åœ°æœåŠ¡å™¨åœ°å€');
            return 'http://localhost:3000';
        }

        // è·å–APIåŸºç¡€URL
        const API_BASE_URL = getApiBaseUrl();
        debugLog(`APIåŸºç¡€URL: ${API_BASE_URL || '(ç›¸å¯¹è·¯å¾„)'}`);

        // ä»localStorageè·å–ç”¨æˆ·ä¿¡æ¯
        function getUserInfo() {
            const userFromLocalStorage = localStorage.getItem('user');
            if (userFromLocalStorage) {
                try {
                    const user = JSON.parse(userFromLocalStorage);
                    debugLog(`ä»localStorageè·å–åˆ°ç”¨æˆ·ä¿¡æ¯: ${user.username}`);
                    return user;
                } catch (e) {
                    debugLog(`è§£ælocalStorageä¸­çš„ç”¨æˆ·ä¿¡æ¯å¤±è´¥: ${e.message}`);
                }
            }
            return null;
        }

        // é€€å‡ºç™»å½•
        function logout() {
            debugLog('é€€å‡ºç™»å½•');
            localStorage.removeItem('token');
            localStorage.removeItem('user');
            sessionStorage.removeItem('token');
            sessionStorage.removeItem('user');
            window.location.href = 'login.html';
        }

        // è·å–URLå‚æ•°
        function getUrlParameter(name) {
            const urlParams = new URLSearchParams(window.location.search);
            return urlParams.get(name);
        }

        // è·å–æ–‡ä»¶åˆ—è¡¨
        async function fetchFiles(path = '') {
            try {
                debugLog(`è·å–æ–‡ä»¶åˆ—è¡¨: ${path}`);
                const response = await fetch(`${API_BASE_URL}/api/files?path=${encodeURIComponent(path)}`, {
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    }
                });

                if (!response.ok) {
                    throw new Error(`è·å–æ–‡ä»¶åˆ—è¡¨å¤±è´¥: ${response.statusText}`);
                }

                const data = await response.json();
                if (!data.success) {
                    throw new Error(data.error || 'è·å–æ–‡ä»¶åˆ—è¡¨å¤±è´¥');
                }
                debugLog(`æˆåŠŸè·å–æ–‡ä»¶åˆ—è¡¨ï¼Œå…± ${data.items.length} ä¸ªé¡¹ç›®`);
                return data.items;
            } catch (error) {
                debugLog(`è·å–æ–‡ä»¶åˆ—è¡¨å‡ºé”™: ${error.message}`);
                alert('è·å–æ–‡ä»¶åˆ—è¡¨å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥æˆ–é‡æ–°ç™»å½•');
                return [];
            }
        }

        // ä¸Šä¼ æ–‡ä»¶
        async function uploadFiles(files, currentPath = '') {
            try {
                debugLog(`å¼€å§‹ä¸Šä¼ æ–‡ä»¶ï¼Œæ•°é‡: ${files.length}`);
                debugLog(`å½“å‰è·¯å¾„: ${currentPath}`);

                // åˆ›å»ºè¿›åº¦æç¤ºå®¹å™¨
                const progressContainer = document.createElement('div');
                progressContainer.className = 'upload-progress-container';
                progressContainer.style.position = 'fixed';
                progressContainer.style.top = '20px';
                progressContainer.style.right = '20px';
                progressContainer.style.width = '300px';
                progressContainer.style.backgroundColor = 'white';
                progressContainer.style.padding = '15px';
                progressContainer.style.borderRadius = '8px';
                progressContainer.style.boxShadow = '0 2px 10px rgba(0,0,0,0.1)';
                progressContainer.style.zIndex = '1000';
                document.body.appendChild(progressContainer);

                // ä¸Šä¼ æ‰€æœ‰æ–‡ä»¶
                const results = [];
                for (const file of files) {
                    try {
                        // åˆ›å»ºå•ä¸ªæ–‡ä»¶çš„è¿›åº¦æ¡
                        const progressDiv = document.createElement('div');
                        progressDiv.style.marginBottom = '10px';
                        progressDiv.innerHTML = `
                            <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                                <span style="font-size: 14px;">${file.name}</span>
                                <span style="font-size: 14px;" class="progress-text">0%</span>
                            </div>
                            <div class="progress-bar" style="height: 4px; background-color: #f0f0f0; border-radius: 2px;">
                                <div class="progress-fill" style="width: 0%; height: 100%; background-color: #4a6cf7; border-radius: 2px; transition: width 0.3s;"></div>
                            </div>
                        `;
                        progressContainer.appendChild(progressDiv);

                        const progressFill = progressDiv.querySelector('.progress-fill');
                        const progressText = progressDiv.querySelector('.progress-text');

                        const formData = new FormData();
                        formData.append('file', file);
                        if (currentPath) {
                            formData.append('path', currentPath);
                        }

                        debugLog(`å‡†å¤‡ä¸Šä¼ æ–‡ä»¶: ${file.name}, å¤§å°: ${formatFileSize(file.size)}`);
                        const apiUrl = `${API_BASE_URL}/api/files/upload`;
                        debugLog(`APIåœ°å€: ${apiUrl}`);
                        const token = localStorage.getItem('token');
                        debugLog(`ä½¿ç”¨ä»¤ç‰Œ: ${token ? token.substring(0, 20) + '...' : 'undefined'}`);

                        // ä½¿ç”¨ XMLHttpRequest æ¥è·å–ä¸Šä¼ è¿›åº¦
                        const xhr = new XMLHttpRequest();
                        xhr.upload.onprogress = (event) => {
                            if (event.lengthComputable) {
                                const percentComplete = (event.loaded / event.total) * 100;
                                progressFill.style.width = percentComplete + '%';
                                progressText.textContent = percentComplete.toFixed(1) + '%';
                                debugLog(`ä¸Šä¼ è¿›åº¦ ${file.name}: ${percentComplete.toFixed(1)}%`);
                            }
                        };

                        const response = await new Promise((resolve, reject) => {
                            // è®¾ç½®è¶…æ—¶æ—¶é—´ï¼ˆ10åˆ†é’Ÿï¼‰
                            xhr.timeout = 600000; // 10åˆ†é’Ÿ

                            xhr.onload = () => {
                                if (xhr.status >= 200 && xhr.status < 300) {
                                    debugLog(`æ–‡ä»¶ ${file.name} ä¸Šä¼ å®Œæˆï¼ŒæœåŠ¡å™¨å“åº”: ${JSON.stringify(xhr.response)}`);
                                    resolve(xhr.response);
                                } else {
                                    debugLog(`æ–‡ä»¶ ${file.name} ä¸Šä¼ å¤±è´¥ï¼ŒçŠ¶æ€ç : ${xhr.status}`);
                                    reject(new Error(`ä¸Šä¼ å¤±è´¥: ${xhr.statusText || 'æœåŠ¡å™¨é”™è¯¯'}`));
                                }
                            };

                            xhr.ontimeout = () => {
                                debugLog(`æ–‡ä»¶ ${file.name} ä¸Šä¼ è¶…æ—¶`);
                                reject(new Error('ä¸Šä¼ è¶…æ—¶ï¼Œè¯·é‡è¯•'));
                            };

                            xhr.onerror = () => {
                                debugLog(`æ–‡ä»¶ ${file.name} ä¸Šä¼ ç½‘ç»œé”™è¯¯`);
                                reject(new Error('ç½‘ç»œé”™è¯¯ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥'));
                            };

                            xhr.onabort = () => {
                                debugLog(`æ–‡ä»¶ ${file.name} ä¸Šä¼ è¢«ä¸­æ–­`);
                                reject(new Error('ä¸Šä¼ è¢«ä¸­æ–­'));
                            };

                            xhr.open('POST', apiUrl);
                            xhr.setRequestHeader('Authorization', `Bearer ${token}`);
                            xhr.responseType = 'json';

                            // æ·»åŠ ä¸Šä¼ å®Œæˆäº‹ä»¶
                            xhr.upload.onload = () => {
                                debugLog(`æ–‡ä»¶ ${file.name} æ•°æ®ä¼ è¾“å®Œæˆï¼Œç­‰å¾…æœåŠ¡å™¨å¤„ç†`);
                                progressText.textContent = 'å¤„ç†ä¸­...';
                            };

                            // æ·»åŠ ä¸Šä¼ é”™è¯¯äº‹ä»¶
                            xhr.upload.onerror = () => {
                                debugLog(`æ–‡ä»¶ ${file.name} ä¸Šä¼ è¿‡ç¨‹ä¸­å‘ç”Ÿé”™è¯¯`);
                                reject(new Error('ä¸Šä¼ è¿‡ç¨‹ä¸­å‘ç”Ÿé”™è¯¯'));
                            };

                            // å¯¹äºå¤§æ–‡ä»¶ï¼Œç‰¹åˆ«æ˜¯è§†é¢‘ï¼Œæ˜¾ç¤ºæç¤º
                            if (file.size > 10 * 1024 * 1024) {
                                debugLog(`å¤§æ–‡ä»¶ä¸Šä¼ : ${file.name}, å¤§å°: ${formatFileSize(file.size)}`);
                                progressText.textContent = 'å‡†å¤‡ä¸Šä¼ å¤§æ–‡ä»¶...';

                                // å¯¹äºè§†é¢‘æ–‡ä»¶ï¼Œæ˜¾ç¤ºç‰¹åˆ«æç¤º
                                if (file.name.match(/\.(mp4|avi|mov|wmv|flv|mkv)$/i)) {
                                    debugLog(`è§†é¢‘æ–‡ä»¶ä¸Šä¼ : ${file.name}`);
                                    progressDiv.style.backgroundColor = '#fff0e0';
                                    const noteDiv = document.createElement('div');
                                    noteDiv.style.fontSize = '12px';
                                    noteDiv.style.color = '#ff6600';
                                    noteDiv.style.marginTop = '5px';
                                    noteDiv.textContent = 'è§†é¢‘æ–‡ä»¶ä»…ä¿å­˜åœ¨æœ¬åœ°æœåŠ¡å™¨ï¼Œä¸ä¼šä¸Šä¼ åˆ°äº‘ç«¯';
                                    progressDiv.appendChild(noteDiv);
                                }
                            }

                            debugLog(`å¼€å§‹å‘é€æ–‡ä»¶ ${file.name} åˆ°æœåŠ¡å™¨`);
                            xhr.send(formData);
                        });

                        debugLog(`æœåŠ¡å™¨å“åº”: ${JSON.stringify(response)}`);

                        if (!response.success) {
                            throw new Error(response.error || 'ä¸Šä¼ å¤±è´¥');
                        }

                        progressDiv.style.backgroundColor = '#f0fff0';
                        progressText.textContent = 'å®Œæˆ';
                        results.push(response);
                        debugLog(`æ–‡ä»¶ ${file.name} ä¸Šä¼ æˆåŠŸ`);
                    } catch (fileError) {
                        debugLog(`å•ä¸ªæ–‡ä»¶ä¸Šä¼ å¤±è´¥: ${fileError.message}`);
                        alert(`æ–‡ä»¶ ${file.name} ä¸Šä¼ å¤±è´¥: ${fileError.message}`);
                    }
                }

                // 3ç§’åç§»é™¤è¿›åº¦æ¡å®¹å™¨
                setTimeout(() => {
                    document.body.removeChild(progressContainer);
                }, 3000);

                if (results.length > 0) {
                    debugLog(`æˆåŠŸä¸Šä¼  ${results.length} ä¸ªæ–‡ä»¶`);
                    alert('æ–‡ä»¶ä¸Šä¼ æˆåŠŸ');
                    return results;
                } else {
                    throw new Error('æ‰€æœ‰æ–‡ä»¶ä¸Šä¼ å¤±è´¥');
                }
            } catch (error) {
                debugLog(`ä¸Šä¼ æ–‡ä»¶å‡ºé”™: ${error.message}`);
                alert(`ä¸Šä¼ æ–‡ä»¶å¤±è´¥: ${error.message}`);
                return null;
            }
        }

        // ä¸‹è½½æ–‡ä»¶
        async function downloadFile(filePath) {
            try {
                debugLog(`å¼€å§‹ä¸‹è½½æ–‡ä»¶: ${filePath}`);
                const response = await fetch(`${API_BASE_URL}/api/files/download?path=${encodeURIComponent(filePath)}`, {
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    }
                });

                if (!response.ok) {
                    throw new Error(`ä¸‹è½½å¤±è´¥: ${response.statusText}`);
                }

                const blob = await response.blob();
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = filePath.split('/').pop();
                document.body.appendChild(a);
                a.click();
                window.URL.revokeObjectURL(url);
                document.body.removeChild(a);
                debugLog('æ–‡ä»¶ä¸‹è½½æˆåŠŸ');
            } catch (error) {
                debugLog(`ä¸‹è½½æ–‡ä»¶å‡ºé”™: ${error.message}`);
                alert('ä¸‹è½½æ–‡ä»¶å¤±è´¥ï¼Œè¯·é‡è¯•');
            }
        }

        // åˆ›å»ºæ–‡ä»¶å¤¹
        async function createFolder(folderName, currentPath = '') {
            try {
                debugLog(`åˆ›å»ºæ–‡ä»¶å¤¹: ${folderName}`);
                const response = await fetch(`${API_BASE_URL}/api/files/create-folder`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('token')}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        path: currentPath,
                        folderName: folderName
                    })
                });

                if (!response.ok) {
                    throw new Error(`åˆ›å»ºæ–‡ä»¶å¤¹å¤±è´¥: ${response.statusText}`);
                }

                const result = await response.json();
                debugLog('æ–‡ä»¶å¤¹åˆ›å»ºæˆåŠŸ');
                alert('æ–‡ä»¶å¤¹åˆ›å»ºæˆåŠŸ');
                return result;
            } catch (error) {
                debugLog(`åˆ›å»ºæ–‡ä»¶å¤¹å‡ºé”™: ${error.message}`);
                alert('åˆ›å»ºæ–‡ä»¶å¤¹å¤±è´¥ï¼Œè¯·é‡è¯•');
                return null;
            }
        }

        // åˆ é™¤æ–‡ä»¶æˆ–æ–‡ä»¶å¤¹
        async function deleteItem(path) {
            try {
                debugLog(`å¼€å§‹åˆ é™¤é¡¹ç›®: ${path}`);
                const apiUrl = `${API_BASE_URL}/api/files?path=${encodeURIComponent(path)}`;
                debugLog(`åˆ é™¤API URL: ${apiUrl}`);

                const token = localStorage.getItem('token');
                debugLog(`ä½¿ç”¨ä»¤ç‰Œ: ${token ? token.substring(0, 20) + '...' : 'undefined'}`);

                const response = await fetch(apiUrl, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                debugLog(`åˆ é™¤å“åº”çŠ¶æ€: ${response.status} ${response.statusText}`);

                if (!response.ok) {
                    const errorText = await response.text();
                    debugLog(`åˆ é™¤å¤±è´¥å“åº”å†…å®¹: ${errorText}`);
                    throw new Error(`åˆ é™¤å¤±è´¥: ${response.statusText} - ${errorText}`);
                }

                const result = await response.json();
                debugLog(`åˆ é™¤æˆåŠŸå“åº”: ${JSON.stringify(result)}`);

                alert('åˆ é™¤æˆåŠŸ');
                return true;
            } catch (error) {
                debugLog(`åˆ é™¤å‡ºé”™: ${error.message}`);
                debugLog(`é”™è¯¯å †æ ˆ: ${error.stack}`);
                alert(`åˆ é™¤å¤±è´¥: ${error.message}`);
                return false;
            }
        }

        // è·å–æ–‡ä»¶å›¾æ ‡
        function getFileIcon(fileName, isDirectory) {
            if (isDirectory) {
                return 'ğŸ“';
            }

            const ext = fileName.split('.').pop().toLowerCase();

            // å›¾ç‰‡æ–‡ä»¶
            if (['jpg', 'jpeg', 'png', 'gif', 'bmp', 'webp', 'svg'].includes(ext)) {
                return 'ğŸ–¼ï¸';
            }

            // è§†é¢‘æ–‡ä»¶
            if (['mp4', 'avi', 'mov', 'wmv', 'flv', 'mkv', 'webm'].includes(ext)) {
                return 'ğŸ¬';
            }

            // éŸ³é¢‘æ–‡ä»¶
            if (['mp3', 'wav', 'ogg', 'flac', 'aac', 'm4a'].includes(ext)) {
                return 'ğŸµ';
            }

            // æ–‡æ¡£æ–‡ä»¶
            if (['doc', 'docx', 'odt', 'rtf'].includes(ext)) {
                return 'ğŸ“„';
            }

            // ç”µå­è¡¨æ ¼
            if (['xls', 'xlsx', 'ods', 'csv'].includes(ext)) {
                return 'ğŸ“Š';
            }

            // æ¼”ç¤ºæ–‡ç¨¿
            if (['ppt', 'pptx', 'odp'].includes(ext)) {
                return 'ğŸ“‘';
            }

            // PDFæ–‡ä»¶
            if (ext === 'pdf') {
                return 'ğŸ“•';
            }

            // å‹ç¼©æ–‡ä»¶
            if (['zip', 'rar', '7z', 'tar', 'gz'].includes(ext)) {
                return 'ğŸ“¦';
            }

            // ä»£ç æ–‡ä»¶
            if (['html', 'css', 'js', 'ts', 'jsx', 'tsx', 'php', 'py', 'java', 'c', 'cpp', 'cs', 'go', 'rb', 'swift'].includes(ext)) {
                return 'ğŸ“';
            }

            // æ–‡æœ¬æ–‡ä»¶
            if (['txt', 'md', 'json', 'xml', 'yml', 'yaml', 'ini', 'log', 'conf'].includes(ext)) {
                return 'ğŸ“ƒ';
            }

            // é»˜è®¤å›¾æ ‡
            return 'ğŸ“„';
        }

        // æ£€æŸ¥æ–‡ä»¶æ˜¯å¦å¯é¢„è§ˆ
        function isPreviewable(fileName) {
            const ext = fileName.split('.').pop().toLowerCase();

            // å¯é¢„è§ˆçš„æ–‡ä»¶ç±»å‹
            const previewableTypes = [
                // å›¾ç‰‡
                'jpg', 'jpeg', 'png', 'gif', 'bmp', 'webp', 'svg',
                // è§†é¢‘
                'mp4', 'webm',
                // éŸ³é¢‘
                'mp3', 'wav', 'ogg',
                // æ–‡æ¡£
                'pdf',
                // æ–‡æœ¬
                'txt', 'md', 'json', 'xml', 'yml', 'yaml', 'html', 'css', 'js'
            ];

            return previewableTypes.includes(ext);
        }

        // é¢„è§ˆæ–‡ä»¶
        async function previewFile(filePath) {
            debugLog(`é¢„è§ˆæ–‡ä»¶: ${filePath}`);

            const fileName = filePath.split('/').pop();
            const ext = fileName.split('.').pop().toLowerCase();

            // åˆ›å»ºé¢„è§ˆæ¨¡æ€æ¡†
            const modal = document.createElement('div');
            modal.className = 'preview-modal';
            modal.style.display = 'flex';

            // åˆ›å»ºé¢„è§ˆå†…å®¹å®¹å™¨
            const content = document.createElement('div');
            content.className = 'preview-content';

            // åˆ›å»ºé¢„è§ˆå¤´éƒ¨
            const header = document.createElement('div');
            header.className = 'preview-header';

            const title = document.createElement('div');
            title.className = 'preview-title';
            title.textContent = fileName;

            const closeBtn = document.createElement('button');
            closeBtn.className = 'preview-close';
            closeBtn.innerHTML = '&times;';
            closeBtn.onclick = () => document.body.removeChild(modal);

            header.appendChild(title);
            header.appendChild(closeBtn);

            content.appendChild(header);

            // æ ¹æ®æ–‡ä»¶ç±»å‹åˆ›å»ºä¸åŒçš„é¢„è§ˆ
            if (['jpg', 'jpeg', 'png', 'gif', 'bmp', 'webp', 'svg'].includes(ext)) {
                // å›¾ç‰‡é¢„è§ˆ
                const img = document.createElement('img');
                img.className = 'preview-image';
                img.src = `/storage/${filePath}`;
                img.alt = fileName;
                img.onload = () => {
                    debugLog(`å›¾ç‰‡åŠ è½½æˆåŠŸ: ${filePath}`);
                };
                img.onerror = () => {
                    debugLog(`å›¾ç‰‡åŠ è½½å¤±è´¥: ${filePath}`);
                    img.src = 'data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIyNCIgaGVpZ2h0PSIyNCIgdmlld0JveD0iMCAwIDI0IDI0IiBmaWxsPSJub25lIiBzdHJva2U9ImN1cnJlbnRDb2xvciIgc3Ryb2tlLXdpZHRoPSIyIiBzdHJva2UtbGluZWNhcD0icm91bmQiIHN0cm9rZS1saW5lam9pbj0icm91bmQiIGNsYXNzPSJmZWF0aGVyIGZlYXRoZXItaW1hZ2UiPjxyZWN0IHg9IjMiIHk9IjMiIHdpZHRoPSIxOCIgaGVpZ2h0PSIxOCIgcng9IjIiIHJ5PSIyIj48L3JlY3Q+PGNpcmNsZSBjeD0iOC41IiBjeT0iOC41IiByPSIxLjUiPjwvY2lyY2xlPjxwb2x5bGluZSBwb2ludHM9IjIxIDE1IDE2IDEwIDUgMjEiPjwvcG9seWxpbmU+PC9zdmc+';
                    title.textContent = `${fileName} (åŠ è½½å¤±è´¥)`;
                };
                content.appendChild(img);
            } else if (['mp4', 'webm'].includes(ext)) {
                // è§†é¢‘é¢„è§ˆ
                const videoContainer = document.createElement('div');
                videoContainer.className = 'video-player-container';

                const video = document.createElement('video');
                video.className = 'video-player';
                video.src = `/storage/${filePath}`;
                video.controls = true;
                video.autoplay = true;
                video.preload = 'metadata';

                video.onloadedmetadata = () => {
                    debugLog(`è§†é¢‘å…ƒæ•°æ®åŠ è½½æˆåŠŸ: ${filePath}, æ—¶é•¿: ${video.duration}ç§’`);
                    title.textContent = `${fileName} (${formatDuration(video.duration)})`;
                };

                video.onerror = () => {
                    debugLog(`è§†é¢‘åŠ è½½å¤±è´¥: ${filePath}`);
                    title.textContent = `${fileName} (åŠ è½½å¤±è´¥)`;
                    videoContainer.innerHTML = '<div style="color: white; padding: 20px; text-align: center;">è§†é¢‘åŠ è½½å¤±è´¥ï¼Œè¯·æ£€æŸ¥æ–‡ä»¶æ ¼å¼æˆ–æƒé™</div>';
                };

                videoContainer.appendChild(video);
                content.appendChild(videoContainer);
            } else if (['mp3', 'wav', 'ogg'].includes(ext)) {
                // éŸ³é¢‘é¢„è§ˆ
                const audio = document.createElement('audio');
                audio.className = 'preview-audio';
                audio.src = `/storage/${filePath}`;
                audio.controls = true;
                audio.autoplay = true;

                audio.onloadedmetadata = () => {
                    debugLog(`éŸ³é¢‘å…ƒæ•°æ®åŠ è½½æˆåŠŸ: ${filePath}, æ—¶é•¿: ${audio.duration}ç§’`);
                    title.textContent = `${fileName} (${formatDuration(audio.duration)})`;
                };

                audio.onerror = () => {
                    debugLog(`éŸ³é¢‘åŠ è½½å¤±è´¥: ${filePath}`);
                    title.textContent = `${fileName} (åŠ è½½å¤±è´¥)`;
                    content.innerHTML = '<div style="color: white; padding: 20px; text-align: center;">éŸ³é¢‘åŠ è½½å¤±è´¥ï¼Œè¯·æ£€æŸ¥æ–‡ä»¶æ ¼å¼æˆ–æƒé™</div>';
                };

                content.appendChild(audio);
            } else if (ext === 'pdf') {
                // PDFé¢„è§ˆ
                const iframe = document.createElement('iframe');
                iframe.className = 'preview-pdf';
                iframe.src = `/storage/${filePath}`;

                iframe.onload = () => {
                    debugLog(`PDFåŠ è½½æˆåŠŸ: ${filePath}`);
                };

                iframe.onerror = () => {
                    debugLog(`PDFåŠ è½½å¤±è´¥: ${filePath}`);
                    iframe.srcdoc = '<div style="padding: 20px; text-align: center;">PDFåŠ è½½å¤±è´¥ï¼Œè¯·æ£€æŸ¥æ–‡ä»¶æ ¼å¼æˆ–æƒé™</div>';
                    title.textContent = `${fileName} (åŠ è½½å¤±è´¥)`;
                };

                content.appendChild(iframe);
            } else if (['txt', 'md', 'json', 'xml', 'yml', 'yaml', 'html', 'css', 'js'].includes(ext)) {
                // æ–‡æœ¬é¢„è§ˆ
                try {
                    const response = await fetch(`/storage/${filePath}`);
                    if (!response.ok) {
                        throw new Error(`è·å–æ–‡ä»¶å¤±è´¥: ${response.statusText}`);
                    }

                    const text = await response.text();

                    const pre = document.createElement('pre');
                    pre.className = 'preview-text';
                    pre.textContent = text;

                    content.appendChild(pre);
                    debugLog(`æ–‡æœ¬åŠ è½½æˆåŠŸ: ${filePath}, å¤§å°: ${text.length}å­—èŠ‚`);
                } catch (error) {
                    debugLog(`æ–‡æœ¬åŠ è½½å¤±è´¥: ${error.message}`);
                    content.innerHTML = '<div style="color: white; padding: 20px; text-align: center;">æ–‡æœ¬åŠ è½½å¤±è´¥ï¼Œè¯·æ£€æŸ¥æ–‡ä»¶æ ¼å¼æˆ–æƒé™</div>';
                    title.textContent = `${fileName} (åŠ è½½å¤±è´¥)`;
                }
            } else {
                // ä¸æ”¯æŒé¢„è§ˆçš„æ–‡ä»¶ç±»å‹
                content.innerHTML = `
                    <div style="color: white; padding: 20px; text-align: center;">
                        <div style="font-size: 48px; margin-bottom: 20px;">${getFileIcon(fileName, false)}</div>
                        <div>æ— æ³•é¢„è§ˆæ­¤ç±»å‹çš„æ–‡ä»¶</div>
                        <div style="margin-top: 10px; font-size: 14px; color: #aaa;">æ–‡ä»¶ç±»å‹: ${ext.toUpperCase()}</div>
                    </div>
                `;
            }

            // åˆ›å»ºæ§åˆ¶æŒ‰é’®
            const controls = document.createElement('div');
            controls.className = 'preview-controls';

            const downloadBtn = document.createElement('button');
            downloadBtn.className = 'preview-btn';
            downloadBtn.innerHTML = 'â¬‡ï¸ ä¸‹è½½æ–‡ä»¶';
            downloadBtn.onclick = () => {
                downloadFile(filePath);
            };

            controls.appendChild(downloadBtn);

            // ç»„è£…æ¨¡æ€æ¡†
            modal.appendChild(content);
            modal.appendChild(controls);

            // æ·»åŠ é”®ç›˜äº‹ä»¶ç›‘å¬
            modal.tabIndex = -1;
            modal.focus();
            modal.addEventListener('keydown', (e) => {
                if (e.key === 'Escape') {
                    document.body.removeChild(modal);
                }
            });

            // ç‚¹å‡»èƒŒæ™¯å…³é—­
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    document.body.removeChild(modal);
                }
            });

            document.body.appendChild(modal);
        }

        // æ ¼å¼åŒ–æ—¶é•¿
        function formatDuration(seconds) {
            const minutes = Math.floor(seconds / 60);
            const remainingSeconds = Math.floor(seconds % 60);
            return `${minutes}:${remainingSeconds.toString().padStart(2, '0')}`;
        }

        // æ¸²æŸ“æ–‡ä»¶åˆ—è¡¨è§†å›¾
        function renderListView(files) {
            debugLog('æ¸²æŸ“åˆ—è¡¨è§†å›¾');
            const container = document.querySelector('.file-list');
            container.innerHTML = `
                <div class="file-list-header">
                    <div></div>
                    <div>åç§°</div>
                    <div>å¤§å°</div>
                    <div>ä¿®æ”¹æ—¥æœŸ</div>
                    <div>æ“ä½œ</div>
                </div>
                <div id="file-items-container"></div>
            `;
            const itemsContainer = document.getElementById('file-items-container');

            files.forEach(file => {
                const fileItem = document.createElement('div');
                fileItem.className = 'file-item';
                fileItem.dataset.name = file.name;
                fileItem.dataset.type = file.isDirectory ? 'directory' : 'file';

                // è·å–æ–‡ä»¶å›¾æ ‡
                const icon = getFileIcon(file.name, file.isDirectory);

                // æ ¼å¼åŒ–æ–‡ä»¶å¤§å°
                const size = file.isDirectory ? '-' : formatFileSize(file.size);

                fileItem.innerHTML = `
                    <div class="file-icon">${icon}</div>
                    <div class="file-name">${file.name}</div>
                    <div class="file-size">${size}</div>
                    <div class="file-date">${new Date(file.modifiedTime).toLocaleDateString()}</div>
                    <div class="file-actions">
                        ${!file.isDirectory ? '<button class="action-btn" title="ä¸‹è½½">â¬‡ï¸</button>' : ''}
                        ${!file.isDirectory && isPreviewable(file.name) ? '<button class="action-btn" title="é¢„è§ˆ">ğŸ‘ï¸</button>' : ''}
                        <button class="action-btn" title="åˆ é™¤">ğŸ—‘ï¸</button>
                    </div>
                `;

                // ä¸ºæ–‡ä»¶å¤¹æ·»åŠ ç‚¹å‡»äº‹ä»¶
                if (file.isDirectory) {
                    fileItem.querySelector('.file-name').addEventListener('click', () => {
                        const currentPath = getUrlParameter('folder') || '';
                        const newPath = currentPath ? `${currentPath}/${file.name}` : file.name;
                        window.location.href = `?folder=${encodeURIComponent(newPath)}`;
                    });
                } else if (isPreviewable(file.name)) {
                    // ä¸ºå¯é¢„è§ˆæ–‡ä»¶æ·»åŠ ç‚¹å‡»äº‹ä»¶
                    fileItem.querySelector('.file-name').addEventListener('click', () => {
                        const currentPath = getUrlParameter('folder') || '';
                        const filePath = currentPath ? `${currentPath}/${file.name}` : file.name;
                        previewFile(filePath);
                    });
                }

                itemsContainer.appendChild(fileItem);
            });
        }

        // æ¸²æŸ“ç½‘æ ¼è§†å›¾
        function renderGridView(files) {
            debugLog('æ¸²æŸ“ç½‘æ ¼è§†å›¾');
            const container = document.querySelector('.file-list');
            container.innerHTML = '';
            container.style.display = 'grid';
            container.style.gridTemplateColumns = 'repeat(auto-fill, minmax(150px, 1fr))';
            container.style.gap = '20px';

            files.forEach(file => {
                const gridItem = document.createElement('div');
                gridItem.className = 'grid-item';
                gridItem.dataset.name = file.name;
                gridItem.dataset.type = file.isDirectory ? 'directory' : 'file';

                // è·å–æ–‡ä»¶å›¾æ ‡
                const icon = getFileIcon(file.name, file.isDirectory);

                // æ ¼å¼åŒ–æ–‡ä»¶å¤§å°
                const size = file.isDirectory ? '-' : formatFileSize(file.size);

                gridItem.innerHTML = `
                    <div class="grid-icon">${icon}</div>
                    <div class="grid-name">${file.name}</div>
                    <div class="grid-info">${size}</div>
                    <div class="grid-actions">
                        ${!file.isDirectory ? '<button class="action-btn" title="ä¸‹è½½">â¬‡ï¸</button>' : ''}
                        ${!file.isDirectory && isPreviewable(file.name) ? '<button class="action-btn" title="é¢„è§ˆ">ğŸ‘ï¸</button>' : ''}
                        <button class="action-btn" title="åˆ é™¤">ğŸ—‘ï¸</button>
                    </div>
                `;

                // ä¸ºæ–‡ä»¶å¤¹æ·»åŠ ç‚¹å‡»äº‹ä»¶
                if (file.isDirectory) {
                    gridItem.querySelector('.grid-name').addEventListener('click', () => {
                        const currentPath = getUrlParameter('folder') || '';
                        const newPath = currentPath ? `${currentPath}/${file.name}` : file.name;
                        window.location.href = `?folder=${encodeURIComponent(newPath)}`;
                    });
                } else if (isPreviewable(file.name)) {
                    // ä¸ºå¯é¢„è§ˆæ–‡ä»¶æ·»åŠ ç‚¹å‡»äº‹ä»¶
                    gridItem.querySelector('.grid-name').addEventListener('click', () => {
                        const currentPath = getUrlParameter('folder') || '';
                        const filePath = currentPath ? `${currentPath}/${file.name}` : file.name;
                        previewFile(filePath);
                    });
                }

                container.appendChild(gridItem);
            });
        }

        // æ ¼å¼åŒ–æ–‡ä»¶å¤§å°
        function formatFileSize(bytes) {
            if (bytes === 0) return '0 B';
            const k = 1024;
            const sizes = ['B', 'KB', 'MB', 'GB', 'TB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        // æ£€æŸ¥ Cloudinary è¿æ¥çŠ¶æ€
        async function checkCloudinaryConnection() {
            try {
                debugLog('æ£€æŸ¥ Cloudinary è¿æ¥çŠ¶æ€');
                const response = await fetch(`${API_BASE_URL}/api/cloudinary/status`, {
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    }
                });

                if (!response.ok) {
                    throw new Error('è¿æ¥æ£€æŸ¥å¤±è´¥');
                }

                const result = await response.json();
                const statusElement = document.getElementById('cloudinary-status');

                if (result.success) {
                    statusElement.className = 'cloudinary-status connected';
                    statusElement.innerHTML = `
                        <span class="cloudinary-status-icon">âœ…</span>
                        <span>Cloudinary å·²è¿æ¥</span>
                        <button class="cloudinary-settings-btn" id="cloudinary-settings-btn">è®¾ç½®</button>
                    `;
                    debugLog('Cloudinary è¿æ¥æ­£å¸¸');
                } else {
                    throw new Error(result.error || 'è¿æ¥å¤±è´¥');
                }
            } catch (error) {
                debugLog(`Cloudinary è¿æ¥æ£€æŸ¥å¤±è´¥: ${error.message}`);
                const statusElement = document.getElementById('cloudinary-status');
                statusElement.className = 'cloudinary-status disconnected';
                statusElement.innerHTML = `
                    <span class="cloudinary-status-icon">âŒ</span>
                    <span>Cloudinary æœªè¿æ¥: ${error.message}</span>
                    <button class="cloudinary-settings-btn" id="cloudinary-settings-btn">è®¾ç½®</button>
                `;
            }
        }

        // æ›´æ–° Cloudinary é…ç½®
        async function updateCloudinaryConfig(apiKey, apiSecret) {
            try {
                debugLog('æ›´æ–° Cloudinary é…ç½®');
                const response = await fetch(`${API_BASE_URL}/api/cloudinary/config`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('token')}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ apiKey, apiSecret })
                });

                if (!response.ok) {
                    throw new Error('é…ç½®æ›´æ–°å¤±è´¥');
                }

                const result = await response.json();
                if (result.success) {
                    debugLog('Cloudinary é…ç½®æ›´æ–°æˆåŠŸ');
                    alert('Cloudinary é…ç½®å·²æ›´æ–°');
                    await checkCloudinaryConnection();
                    return true;
                } else {
                    throw new Error(result.error || 'é…ç½®æ›´æ–°å¤±è´¥');
                }
            } catch (error) {
                debugLog(`æ›´æ–° Cloudinary é…ç½®å¤±è´¥: ${error.message}`);
                alert(`æ›´æ–°å¤±è´¥: ${error.message}`);
                return false;
            }
        }

        // é¡µé¢åŠ è½½å®Œæˆåæ‰§è¡Œ
        window.addEventListener('DOMContentLoaded', async function () {
            debugLog('é¡µé¢åŠ è½½å®Œæˆ');

            // è·å–DOMå…ƒç´ 
            const usernameElement = document.getElementById('username');
            const logoutBtn = document.getElementById('logout-btn');
            const listViewBtn = document.getElementById('list-view-btn');
            const gridViewBtn = document.getElementById('grid-view-btn');
            const uploadBtn = document.getElementById('upload-btn');
            const newFolderBtn = document.getElementById('new-folder-btn');
            const folderPath = document.getElementById('folder-path');

            // ç»‘å®šé€€å‡ºç™»å½•æŒ‰é’®äº‹ä»¶
            logoutBtn.addEventListener('click', logout);

            // è·å–ç”¨æˆ·ä¿¡æ¯
            const user = getUserInfo();
            if (!user) {
                debugLog('æœªæ‰¾åˆ°ç”¨æˆ·ä¿¡æ¯ï¼Œé‡å®šå‘åˆ°ç™»å½•é¡µé¢');
                window.location.href = 'login.html';
                return;
            }

            // æ˜¾ç¤ºç”¨æˆ·å
            usernameElement.textContent = user.username;
            debugLog(`æ˜¾ç¤ºç”¨æˆ·ä¿¡æ¯: ${user.username}`);

            // è·å–å½“å‰è·¯å¾„
            let currentPath = getUrlParameter('folder') || '';
            if (currentPath) {
                debugLog(`æŒ‡å®šçš„æ–‡ä»¶å¤¹: ${currentPath}`);
                folderPath.innerHTML = currentPath.split('/').map(segment =>
                    `<span class="separator">/</span><span>${segment}</span>`
                ).join('');
            }

            // åŠ è½½æ–‡ä»¶åˆ—è¡¨
            const files = await fetchFiles(currentPath);
            renderListView(files);
            debugLog('æ¸²æŸ“æ–‡ä»¶åˆ—è¡¨è§†å›¾');

            // æ›´æ–°ä¸Šä¼ æŒ‰é’®äº‹ä»¶
            uploadBtn.addEventListener('click', function () {
                debugLog('ç‚¹å‡»ä¸Šä¼ æŒ‰é’®');
                const input = document.createElement('input');
                input.type = 'file';
                input.multiple = true;
                input.onchange = async (e) => {
                    const files = Array.from(e.target.files);
                    await uploadFiles(files, currentPath);
                    const updatedFiles = await fetchFiles(currentPath);
                    if (listViewBtn.classList.contains('active')) {
                        renderListView(updatedFiles);
                    } else {
                        renderGridView(updatedFiles);
                    }
                };
                input.click();
            });

            // æ›´æ–°æ–°å»ºæ–‡ä»¶å¤¹æŒ‰é’®äº‹ä»¶
            newFolderBtn.addEventListener('click', async function () {
                debugLog('ç‚¹å‡»æ–°å»ºæ–‡ä»¶å¤¹æŒ‰é’®');
                const folderName = prompt('è¯·è¾“å…¥æ–‡ä»¶å¤¹åç§°ï¼š');
                if (folderName) {
                    await createFolder(folderName, currentPath);
                    const updatedFiles = await fetchFiles(currentPath);
                    if (listViewBtn.classList.contains('active')) {
                        renderListView(updatedFiles);
                    } else {
                        renderGridView(updatedFiles);
                    }
                }
            });

            // ç»‘å®šè§†å›¾åˆ‡æ¢æŒ‰é’®äº‹ä»¶
            listViewBtn.addEventListener('click', function () {
                listViewBtn.classList.add('active');
                gridViewBtn.classList.remove('active');
                renderListView(files);
                debugLog('åˆ‡æ¢åˆ°åˆ—è¡¨è§†å›¾');
            });

            gridViewBtn.addEventListener('click', function () {
                gridViewBtn.classList.add('active');
                listViewBtn.classList.remove('active');
                renderGridView(files);
                debugLog('åˆ‡æ¢åˆ°ç½‘æ ¼è§†å›¾');
            });

            // æ›´æ–°æ–‡ä»¶æ“ä½œäº‹ä»¶
            document.addEventListener('click', async function (e) {
                if (e.target.classList.contains('action-btn')) {
                    const fileItem = e.target.closest('.file-item') || e.target.closest('.grid-item');
                    if (!fileItem) return;

                    const fileName = fileItem.dataset.name;
                    const currentPath = getUrlParameter('folder') || '';
                    const filePath = currentPath ? `${currentPath}/${fileName}` : fileName;
                    const action = e.target.title;

                    debugLog(`ç‚¹å‡»æ–‡ä»¶æ“ä½œæŒ‰é’®: ${action}, æ–‡ä»¶: ${fileName}, è·¯å¾„: ${filePath}`);

                    switch (action) {
                        case 'ä¸‹è½½':
                            await downloadFile(filePath);
                            break;
                        case 'é¢„è§ˆ':
                            previewFile(filePath);
                            break;
                        case 'åˆ é™¤':
                            if (confirm(`ç¡®å®šè¦åˆ é™¤ ${fileName} å—ï¼Ÿ`)) {
                                debugLog(`ç¡®è®¤åˆ é™¤æ–‡ä»¶: ${filePath}`);
                                const result = await deleteItem(filePath);
                                debugLog(`åˆ é™¤ç»“æœ: ${JSON.stringify(result)}`);

                                if (result) {
                                    debugLog(`é‡æ–°åŠ è½½æ–‡ä»¶åˆ—è¡¨`);
                                    const updatedFiles = await fetchFiles(currentPath);
                                    if (listViewBtn.classList.contains('active')) {
                                        renderListView(updatedFiles);
                                    } else {
                                        renderGridView(updatedFiles);
                                    }
                                }
                            }
                            break;
                    }
                }
            });

            // æ£€æŸ¥ Cloudinary è¿æ¥çŠ¶æ€
            await checkCloudinaryConnection();

            // è®¾ç½®æ¨¡æ€æ¡†ç›¸å…³äº‹ä»¶
            const modal = document.getElementById('cloudinary-settings-modal');
            const settingsBtn = document.getElementById('cloudinary-settings-btn');
            const closeBtn = document.getElementById('modal-close');
            const cancelBtn = document.getElementById('modal-cancel');
            const saveBtn = document.getElementById('save-cloudinary-settings');

            settingsBtn.addEventListener('click', function () {
                modal.style.display = 'flex';
            });

            closeBtn.addEventListener('click', function () {
                modal.style.display = 'none';
            });

            cancelBtn.addEventListener('click', function () {
                modal.style.display = 'none';
            });

            saveBtn.addEventListener('click', async function () {
                const apiKey = document.getElementById('cloudinary-api-key').value;
                const apiSecret = document.getElementById('cloudinary-api-secret').value;

                if (!apiKey || !apiSecret) {
                    alert('è¯·è¾“å…¥ API Key å’Œ API Secret');
                    return;
                }

                const success = await updateCloudinaryConfig(apiKey, apiSecret);
                if (success) {
                    modal.style.display = 'none';
                }
            });

            // ç‚¹å‡»æ¨¡æ€æ¡†å¤–éƒ¨å…³é—­
            window.addEventListener('click', function (event) {
                if (event.target === modal) {
                    modal.style.display = 'none';
                }
            });
        });
    </script>
</body>

</html>